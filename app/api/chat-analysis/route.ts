import Anthropic from '@anthropic-ai/sdk'
import { NextResponse } from 'next/server'

const client = new Anthropic({ apiKey: process.env.ANTHROPIC_API_KEY! })

const SYSTEM_PROMPT_CHAT = `ã‚ãªãŸã¯å°±æ´»æ”¯æ´ã®ãƒ—ãƒ­ã®ã‚­ãƒ£ãƒªã‚¢ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ã§ã™ã€‚å¤§å­¦ç”Ÿã®è‡ªå·±åˆ†æã‚’ä¼šè©±å½¢å¼ã§ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚

## ã‚ãªãŸã®å½¹å‰²
- ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ã§è¦ªã—ã¿ã‚„ã™ã„ãƒˆãƒ¼ãƒ³ã§è³ªå•ã™ã‚‹ï¼ˆã€Œã€œã ã­ï¼ã€ã€Œã™ã”ã„ã­ï¼ã€ãªã©ï¼‰
- å­¦ç”Ÿã®å›ç­”ã‚’å—ã‘æ­¢ã‚ã¦ã‹ã‚‰ã€è‡ªç„¶ã«æ¬¡ã®è³ªå•ã‚„æ·±æ˜ã‚Šã‚’ã™ã‚‹
- 1å›ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§è³ªå•ã¯1ã¤ã ã‘ã«ã™ã‚‹ï¼ˆè³ªå•æ”»ã‚ã«ã—ãªã„ï¼‰
- å­¦ç”ŸãŒã€Œå¤§ã—ãŸã“ã¨ã—ã¦ãªã„ã€ã¨è¨€ã£ã¦ã‚‚ã€ãƒã‚¸ãƒ†ã‚£ãƒ–ã«å—ã‘æ­¢ã‚ã¦å¼•ãå‡ºã™

## ã‚«ãƒãƒ¼ã™ã¹ããƒˆãƒ”ãƒƒã‚¯ï¼ˆå…¨éƒ¨èãå¿…è¦ã¯ãªã„ã€‚è‡ªç„¶ãªæµã‚Œã§ï¼‰
- å­¦æ¥­ãƒ»ã‚¼ãƒŸãƒ»ç ”ç©¶
- ã‚µãƒ¼ã‚¯ãƒ«ãƒ»éƒ¨æ´»å‹•
- ã‚¢ãƒ«ãƒã‚¤ãƒˆãƒ»ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ³
- ãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢ãƒ»èª²å¤–æ´»å‹•
- è¶£å‘³ã‚„æ—¥å¸¸ã§ã®å·¥å¤«ãƒ»é ‘å¼µã‚Š

## æ·±æ˜ã‚Šã®ã‚³ãƒ„
- ã€Œãªãœãã†ã—ã‚ˆã†ã¨æ€ã£ãŸã®ï¼Ÿã€ï¼ˆå‹•æ©Ÿï¼‰
- ã€Œå…·ä½“çš„ã«ã©ã‚“ãªå·¥å¤«ã‚’ã—ãŸï¼Ÿã€ï¼ˆè¡Œå‹•ï¼‰
- ã€Œãã®çµæœã©ã†ãªã£ãŸï¼Ÿã€ï¼ˆæˆæœï¼‰
- ã€Œãã®çµŒé¨“ã‹ã‚‰ä½•ã‚’å­¦ã‚“ã ï¼Ÿã€ï¼ˆå­¦ã³ï¼‰

## é‡è¦ãªãƒ«ãƒ¼ãƒ«
- 1ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ = çŸ­ã„å—ã‘æ­¢ã‚ + 1ã¤ã®è³ªå•ï¼ˆé•·ãã—ã™ããªã„ï¼‰
- 3ã€œ4å¾€å¾©ã”ã¨ã«ã€Œä»–ã®ã“ã¨ã‚‚ã†å°‘ã—èã„ã¦ã„ã„ï¼Ÿã€ã¨è©±é¡Œã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
- å­¦ç”Ÿã®å›ç­”ãŒçŸ­ãã¦ã‚‚è²¬ã‚ãªã„ã€‚ã€Œã‚‚ã†å°‘ã—è©³ã—ãèã„ã¦ã‚‚ã„ã„ï¼Ÿã€ã¨å„ªã—ãæ·±æ˜ã‚Š
- çµ¶å¯¾ã«æ¶ç©ºã®ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã‚’ä½œã‚‰ãªã„`

const SYSTEM_PROMPT_ANALYZE = `ã‚ãªãŸã¯å°±æ´»æ”¯æ´ã®ãƒ—ãƒ­ã®ã‚­ãƒ£ãƒªã‚¢ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ã§ã™ã€‚å­¦ç”Ÿã¨ã®ä¼šè©±ãƒ­ã‚°ã‹ã‚‰è‡ªå·±åˆ†æçµæœã‚’æŠ½å‡ºã—ã¾ã™ã€‚

## å‡ºåŠ›å½¢å¼ï¼ˆå¿…ãšJSONå½¢å¼ã§è¿”ã—ã¦ãã ã•ã„ï¼‰:
{
  "gakuchikaCandiates": [
    {
      "title": "ã‚¬ã‚¯ãƒã‚«ã®ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä¾‹ï¼šé£²é£Ÿåº—ã§ã®æ–°äººæ•™è‚²æ”¹é©ï¼‰",
      "summary": "ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã®è¦ç´„ï¼ˆ3ã€œ4æ–‡ï¼‰",
      "strengths": ["ã“ã®çµŒé¨“ã§ä¼ã‚ã‚‹å¼·ã¿1", "å¼·ã¿2", "å¼·ã¿3"]
    }
  ],
  "selfPR": "è‡ªå·±PRã®ç´ æ¡ˆï¼ˆ300å­—ç¨‹åº¦ã€‚STARæ³•ã§æ§‹æˆï¼‰",
  "values": ["ä¸»ä½“æ€§", "å”èª¿æ€§", "èª²é¡Œè§£æ±ºåŠ›"],
  "topicsCovered": ["å­¦æ¥­", "ã‚µãƒ¼ã‚¯ãƒ«", "ã‚¢ãƒ«ãƒã‚¤ãƒˆ"]
}

## é‡è¦ãªãƒ«ãƒ¼ãƒ«:
- ã‚¬ã‚¯ãƒã‚«å€™è£œã¯æœ€å¤§3ã¤æŠ½å‡ºã€‚ä¼šè©±ãŒå°‘ãªãã¦ã‚‚1ã¤ã¯ææ¡ˆã™ã‚‹
- ä¼šè©±ã§å‡ºãŸå…·ä½“çš„ãªã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ãƒ»æ•°å­—ã®ã¿ä½¿ç”¨ã€‚æ¶ç©ºã®æ•°å­—ã¯çµ¶å¯¾ã«ç”Ÿæˆã—ãªã„
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè©±ã—ã¦ã„ãªã„å†…å®¹ã¯ä½¿ã‚ãªã„
- è‡ªå·±PRã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¼šè©±å†…å®¹ã®ã¿ã‚’ãƒ™ãƒ¼ã‚¹ã«ã™ã‚‹
- ã™ã¹ã¦æ—¥æœ¬èªã§å›ç­”
- JSONä»¥å¤–ã®ãƒ†ã‚­ã‚¹ãƒˆã¯å‡ºåŠ›ã—ãªã„`

export async function POST(req: Request) {
  try {
    const { messages, mode } = await req.json()

    if (mode === 'analyze') {
      // åˆ†æãƒ¢ãƒ¼ãƒ‰ï¼šä¼šè©±ãƒ­ã‚°ã‹ã‚‰è‡ªå·±åˆ†æçµæœã‚’æŠ½å‡º
      const conversationLog = messages
        .map((m: any) => `${m.role === 'user' ? 'å­¦ç”Ÿ' : 'ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼'}: ${m.content}`)
        .join('\n')

      const response = await client.messages.create({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 2000,
        system: SYSTEM_PROMPT_ANALYZE,
        messages: [{
          role: 'user',
          content: `ä»¥ä¸‹ã®ä¼šè©±ãƒ­ã‚°ã‹ã‚‰è‡ªå·±åˆ†æçµæœã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚\n\n${conversationLog}`
        }]
      })

      const text = response.content[0].type === 'text' ? response.content[0].text : ''
      const jsonMatch = text.match(/\{[\s\S]*\}/)
      if (!jsonMatch) return NextResponse.json({ error: 'åˆ†æã«å¤±æ•—ã—ã¾ã—ãŸ' }, { status: 500 })

      return NextResponse.json(JSON.parse(jsonMatch[0]))
    } else {
      // ãƒãƒ£ãƒƒãƒˆãƒ¢ãƒ¼ãƒ‰ï¼šæ¬¡ã®è³ªå•ã‚’ç”Ÿæˆ
      const apiMessages = messages.map((m: any) => ({
        role: m.role as 'user' | 'assistant',
        content: m.content
      }))

      // åˆå›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆ
      if (apiMessages.length === 0) {
        return NextResponse.json({
          message: 'ã¯ã˜ã‚ã¾ã—ã¦ï¼å°±æ´»ã®è‡ªå·±åˆ†æã‚’ä¸€ç·’ã«ã‚„ã£ã¦ã„ã“ã† ğŸ’ª\n\nã¾ãšã¯æ°—è»½ã«æ•™ãˆã¦ã»ã—ã„ã‚“ã ã‘ã©ã€å¤§å­¦ã§ã¯ä½•ã‚’å‹‰å¼·ã—ã¦ã‚‹ï¼Ÿã‚¼ãƒŸã¨ã‹å°‚æ”»ãŒã‚ã‚Œã°æ•™ãˆã¦ï¼'
        })
      }

      const response = await client.messages.create({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 300,
        system: SYSTEM_PROMPT_CHAT,
        messages: apiMessages
      })

      const text = response.content[0].type === 'text' ? response.content[0].text : ''
      return NextResponse.json({ message: text })
    }
  } catch (error: any) {
    console.error('Chat analysis error:', error)
    return NextResponse.json({ error: error.message }, { status: 500 })
  }
}
