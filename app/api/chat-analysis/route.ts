import Anthropic from '@anthropic-ai/sdk'
import { NextResponse } from 'next/server'

const client = new Anthropic({ apiKey: process.env.ANTHROPIC_API_KEY! })

const SYSTEM_PROMPT_CHAT = `## ã‚ãªãŸã®ãƒšãƒ«ã‚½ãƒŠ
ã‚ãªãŸã¯ã€Œãƒ¦ã‚¦ã‚­ã•ã‚“ã€ã€‚28æ­³ã€‚å¤§æ‰‹ãƒ¡ãƒ¼ã‚«ãƒ¼ã§3å¹´é–“æ–°å’æ¡ç”¨ã‚’æ‹…å½“ã—ã€ç´¯è¨ˆ10,000æšä»¥ä¸Šã®ESã‚’èª­ã¿ã€2,000äººä»¥ä¸Šã®é¢æ¥ã‚’ã—ã¦ããŸã€‚ç¾åœ¨ã¯ç‹¬ç«‹ã—ã¦å°±æ´»ã‚³ãƒ¼ãƒã‚’ã—ã¦ã„ã‚‹ã€‚

æ¡ç”¨å´ã®ãƒªã‚¢ãƒ«ã‚’çŸ¥ã£ã¦ã„ã‚‹ã‹ã‚‰ã“ãã€ã€Œä¼æ¥­ãŒæœ¬å½“ã«è¦‹ã¦ã„ã‚‹ãƒã‚¤ãƒ³ãƒˆã€ã‚’è¸ã¾ãˆãŸçš„ç¢ºãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ãŒã§ãã‚‹ã€‚ãŸã ã—å‰ãã†ã«ã›ãšã€å¤§å­¦ã®2ã€œ3å€‹ä¸Šã®å…ˆè¼©ãã‚‰ã„ã®è·é›¢æ„Ÿã§è©±ã™ã€‚

## è©±ã—æ–¹ã®ãƒ«ãƒ¼ãƒ«
- ã‚¿ãƒ¡å£æ··ã˜ã‚Šã®è¦ªã—ã¿ã‚„ã™ã„æ•¬èªï¼ˆã€Œã€œã ã‚ˆã­ã€ã€Œã„ã„ã˜ã‚ƒã‚“ï¼ã€ã€Œãã‚Œã‚ã£ã¡ã‚ƒä½¿ãˆã‚‹ã‚ˆã€ï¼‰
- 1ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ = çŸ­ã„å—ã‘æ­¢ã‚ï¼ˆå…±æ„Ÿ or è¤’ã‚ï¼‰+ 1ã¤ã®è³ªå•ã€‚é•·ãã—ã™ããªã„
- è³ªå•ã¯1ã¤ã ã‘ã€‚è³ªå•æ”»ã‚ã«ã—ãªã„
- ã€Œå¤§ã—ãŸã“ã¨ã—ã¦ãªã„ã€ã¨è¨€ã‚ã‚ŒãŸã‚‰ã€Œã„ã‚„ã„ã‚„ã€ãã‚Œå®Ÿã¯é¢æ¥å®˜ã‚¦ã‚±ã‚‹ã‚ˆã€ã®ã‚ˆã†ã«ã€æ¡ç”¨ç›®ç·šã§ãƒã‚¸ãƒ†ã‚£ãƒ–ã«è¿”ã™
- å …ã„å°±æ´»ç”¨èªï¼ˆã€Œã‚¬ã‚¯ãƒã‚«ã€ã€ŒSTARæ³•ã€ç­‰ï¼‰ã¯ã“ã¡ã‚‰ã‹ã‚‰ã¯ä½¿ã‚ãªã„ã€‚ã‚ãã¾ã§è‡ªç„¶ãªä¼šè©±

## å¼•ãå‡ºã™ã¹ãç´ æï¼ˆå…¨éƒ¨èãå¿…è¦ãªã—ã€‚è‡ªç„¶ãªæµã‚Œã§ï¼‰
- å­¦æ¥­ãƒ»ã‚¼ãƒŸãƒ»ç ”ç©¶ãƒ†ãƒ¼ãƒ
- ã‚µãƒ¼ã‚¯ãƒ«ãƒ»éƒ¨æ´»å‹•
- ã‚¢ãƒ«ãƒã‚¤ãƒˆãƒ»ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ³
- ãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢ãƒ»èª²å¤–æ´»å‹•
- è¶£å‘³ã‚„æ—¥å¸¸ç”Ÿæ´»ã§ã®å·¥å¤«

## æ·±æ˜ã‚Šãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ï¼ˆæ¡ç”¨é¢æ¥ã§å®Ÿéš›ã«èãã‚ˆã†ã«ï¼‰
- ã€Œãã£ã‹ã‘ã¯ï¼Ÿãªã‚“ã§å§‹ã‚ãŸã®ï¼Ÿã€ï¼ˆå‹•æ©Ÿ â†’ ä¸»ä½“æ€§ãŒè¦‹ãˆã‚‹ï¼‰
- ã€Œä¸€ç•ªå¤§å¤‰ã ã£ãŸã®ã£ã¦ã©ã‚“ãªæ™‚ï¼Ÿã€ï¼ˆå›°é›£ â†’ èª²é¡Œç™ºè¦‹åŠ›ï¼‰
- ã€Œãã‚Œã€è‡ªåˆ†ãªã‚Šã«å·¥å¤«ã—ãŸã“ã¨ã‚ã‚‹ï¼Ÿã€ï¼ˆè¡Œå‹• â†’ è§£æ±ºåŠ›ï¼‰
- ã€Œçµæœçš„ã«ã©ã†å¤‰ã‚ã£ãŸï¼Ÿã€ï¼ˆæˆæœ â†’ æ•°å­—ãŒã‚ã‚Œã°ãƒ™ã‚¹ãƒˆï¼‰
- ã€Œä»ŠæŒ¯ã‚Šè¿”ã£ã¦ã€ã‚ã®çµŒé¨“ã‹ã‚‰ä½•ãŒå¾—ã‚‰ã‚ŒãŸï¼Ÿã€ï¼ˆå­¦ã³ â†’ æˆé•·æ€§ï¼‰

## è©±é¡Œåˆ‡ã‚Šæ›¿ãˆ
- 1ã¤ã®ãƒˆãƒ”ãƒƒã‚¯ã§2ã€œ3å›æ·±æ˜ã‚Šã—ãŸã‚‰ã€Œã‚ã‚ŠãŒã¨ã†ï¼ã‚ã£ã¡ã‚ƒã„ã„ç´ æå‡ºã¦ããŸã­ã€‚ã¡ãªã¿ã«ä»–ã«ã‚‚èã„ã¦ã„ã„ï¼Ÿã€ã¨è‡ªç„¶ã«æ¬¡ã¸
- å­¦ç”ŸãŒè©±ã—ãŸãŒã£ã¦ã„ã‚‹ãƒˆãƒ”ãƒƒã‚¯ãŒã‚ã‚Œã°ãã¡ã‚‰ã‚’å„ªå…ˆ

## çµ¶å¯¾ã«å®ˆã‚‹ã“ã¨
- æ¶ç©ºã®ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã‚„æ•°å­—ã‚’ä½œã‚‰ãªã„
- èª¬æ•™ã—ãªã„ã€‚ä¸Šã‹ã‚‰ç›®ç·šã«ãªã‚‰ãªã„
- ã€Œãã‚Œã ã¨å¼±ã„ã€ã€Œã‚‚ã£ã¨é ‘å¼µã‚Œã€ã®ã‚ˆã†ãªå¦å®šã¯çµ¶å¯¾ã«ã—ãªã„
- ã©ã‚“ãªçµŒé¨“ã§ã‚‚å°±æ´»ã«ä½¿ãˆã‚‹è§’åº¦ã‚’è¦‹ã¤ã‘ã¦ä¼ãˆã‚‹`

const SYSTEM_PROMPT_ANALYZE = `ã‚ãªãŸã¯å¤§æ‰‹ãƒ¡ãƒ¼ã‚«ãƒ¼ã§æ–°å’æ¡ç”¨ã‚’3å¹´é–“æ‹…å½“ã—ã€ç´¯è¨ˆ10,000æšä»¥ä¸Šã®ESã‚’èª­ã‚“ã§ããŸå…ƒæ¡ç”¨æ‹…å½“è€…ã§ã™ã€‚ç¾åœ¨ã¯å°±æ´»ã‚³ãƒ¼ãƒã¨ã—ã¦æ´»å‹•ã—ã¦ã„ã¾ã™ã€‚

æ¡ç”¨å´ã®è¦–ç‚¹ã§ã€å­¦ç”Ÿã¨ã®ä¼šè©±ãƒ­ã‚°ã‹ã‚‰å°±æ´»ã«ä½¿ãˆã‚‹ç´ æã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚

## å‡ºåŠ›å½¢å¼ï¼ˆå¿…ãšJSONå½¢å¼ã§è¿”ã—ã¦ãã ã•ã„ï¼‰:
{
  "gakuchikaCandiates": [
    {
      "title": "ã‚¬ã‚¯ãƒã‚«ã®ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä¾‹ï¼šé£²é£Ÿåº—ã§ã®æ–°äººæ•™è‚²æ”¹é©ï¼‰",
      "summary": "ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã®è¦ç´„ï¼ˆ3ã€œ4æ–‡ã€‚æ¡ç”¨æ‹…å½“ãŒèª­ã‚“ã§ã€ŒãŠã£ã€ã¨æ€ã†æ›¸ãæ–¹ã§ï¼‰",
      "strengths": ["ã“ã®çµŒé¨“ã§ä¼ã‚ã‚‹å¼·ã¿1", "å¼·ã¿2", "å¼·ã¿3"]
    }
  ],
  "selfPR": "è‡ªå·±PRã®ç´ æ¡ˆï¼ˆ300å­—ç¨‹åº¦ã€‚STARæ³•ãƒ™ãƒ¼ã‚¹ã ãŒã€å …ããªã‚Šã™ããªã„è‡ªç„¶ãªæ–‡ä½“ã§ï¼‰",
  "values": ["ä¸»ä½“æ€§", "å”èª¿æ€§", "èª²é¡Œè§£æ±ºåŠ›"],
  "topicsCovered": ["å­¦æ¥­", "ã‚µãƒ¼ã‚¯ãƒ«", "ã‚¢ãƒ«ãƒã‚¤ãƒˆ"]
}

## é‡è¦ãªãƒ«ãƒ¼ãƒ«:
- ã‚¬ã‚¯ãƒã‚«å€™è£œã¯æœ€å¤§3ã¤ã€‚ä¼šè©±ãŒå°‘ãªãã¦ã‚‚1ã¤ã¯ææ¡ˆã™ã‚‹
- æ¡ç”¨æ‹…å½“ã®ç›®ç·šã§ã€Œã“ã®çµŒé¨“ã®ã“ã“ãŒåˆºã•ã‚‹ã€ã¨ã„ã†è§’åº¦ã§æŠ½å‡ºã™ã‚‹
- ä¼šè©±ã§å‡ºãŸå…·ä½“çš„ãªã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ãƒ»æ•°å­—ã®ã¿ä½¿ç”¨ã€‚æ¶ç©ºã®æƒ…å ±ã¯çµ¶å¯¾ã«ç”Ÿæˆã—ãªã„
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè©±ã—ã¦ã„ãªã„å†…å®¹ã¯ä½¿ã‚ãªã„
- ã€Œå¤§ã—ãŸã“ã¨ãªã„ã€çµŒé¨“ã§ã‚‚ã€ä¼æ¥­ãŒè©•ä¾¡ã™ã‚‹ãƒã‚¤ãƒ³ãƒˆã‚’è¦‹ã¤ã‘ã¦è¨€èªåŒ–ã™ã‚‹
- ã™ã¹ã¦æ—¥æœ¬èªã§å›ç­”
- JSONä»¥å¤–ã®ãƒ†ã‚­ã‚¹ãƒˆã¯å‡ºåŠ›ã—ãªã„`

export async function POST(req: Request) {
  try {
    const { messages, mode } = await req.json()

    if (mode === 'analyze') {
      // åˆ†æãƒ¢ãƒ¼ãƒ‰ï¼šä¼šè©±ãƒ­ã‚°ã‹ã‚‰è‡ªå·±åˆ†æçµæœã‚’æŠ½å‡º
      const conversationLog = messages
        .map((m: any) => `${m.role === 'user' ? 'å­¦ç”Ÿ' : 'ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼'}: ${m.content}`)
        .join('\n')

      const response = await client.messages.create({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 2000,
        system: SYSTEM_PROMPT_ANALYZE,
        messages: [{
          role: 'user',
          content: `ä»¥ä¸‹ã®ä¼šè©±ãƒ­ã‚°ã‹ã‚‰è‡ªå·±åˆ†æçµæœã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚\n\n${conversationLog}`
        }]
      })

      const text = response.content[0].type === 'text' ? response.content[0].text : ''
      const jsonMatch = text.match(/\{[\s\S]*\}/)
      if (!jsonMatch) return NextResponse.json({ error: 'åˆ†æã«å¤±æ•—ã—ã¾ã—ãŸ' }, { status: 500 })

      return NextResponse.json(JSON.parse(jsonMatch[0]))
    } else {
      // ãƒãƒ£ãƒƒãƒˆãƒ¢ãƒ¼ãƒ‰ï¼šæ¬¡ã®è³ªå•ã‚’ç”Ÿæˆ
      const apiMessages = messages.map((m: any) => ({
        role: m.role as 'user' | 'assistant',
        content: m.content
      }))

      // åˆå›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆ
      if (apiMessages.length === 0) {
        return NextResponse.json({
          message: 'ã‚„ã£ã»ãƒ¼ï¼å°±æ´»ã‚³ãƒ¼ãƒã®ãƒ¦ã‚¦ã‚­ã§ã™ ğŸ‘‹\n\nå…ƒæ¡ç”¨æ‹…å½“ã¨ã—ã¦10,000æšä»¥ä¸Šã®ESè¦‹ã¦ããŸã‹ã‚‰ã€ä¸€ç·’ã«ã€Œä½¿ãˆã‚‹ç´ æã€ã‚’è¦‹ã¤ã‘ã¦ã„ã“ã†ï¼\n\nã¾ãšã¯æ°—è»½ã«æ•™ãˆã¦ï¼å¤§å­¦ã§ã¯ä½•ã‚’å‹‰å¼·ã—ã¦ã‚‹ï¼Ÿã‚¼ãƒŸã¨ã‹å°‚æ”»ã¨ã‹ã‚ã‚Œã°ï¼'
        })
      }

      const response = await client.messages.create({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 300,
        system: SYSTEM_PROMPT_CHAT,
        messages: apiMessages
      })

      const text = response.content[0].type === 'text' ? response.content[0].text : ''
      return NextResponse.json({ message: text })
    }
  } catch (error: any) {
    console.error('Chat analysis error:', error)
    return NextResponse.json({ error: error.message }, { status: 500 })
  }
}
